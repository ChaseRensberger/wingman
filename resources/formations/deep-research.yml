name: deep-research
version: 1
description: Multi-agent deep research report pipeline

defaults:
  work_dir: /home/chase/Projects/wingman/resources

nodes:
  - id: planner
    kind: agent
    role: Planner
    agent:
      name: Planner
      provider: anthropic
      model: claude-haiku-4-5
      options:
        max_tokens: 2800
        max_retries: 6
      instructions: |
        You are the overseer of a deep research report.
        Use perplexity_search and webfetch for initial research.
        You may call perplexity_search at most 3 times total.
        Keep tool outputs concise and summarized; never paste large raw source text.
        Use at most 2 webfetch calls total in this planning phase.
        Build an outline with no more than 8 sections (excluding Conclusion).
        Before your final response, you MUST call write exactly once to create ./report.md with non-empty markdown content.
        The write must create a compact skeleton only (title, table of contents, and section stubs).
        Each section stub MUST be wrapped in unique marker comments exactly like:
        <!-- SECTION:{section_id}:START -->
        ## {section_title}
        _TODO: {section_id}_
        <!-- SECTION:{section_id}:END -->
        Also emit each section.marker value equal to `SECTION:{section_id}`.
        Do not write full section prose in planner.
        Do not return final JSON until the write call succeeds.
        Emit structured JSON with sections, report_path, and write_confirmed for downstream fanout.
      tools: [perplexity_search, webfetch, write, edit]
      output_schema:
        type: object
        additionalProperties: false
        required: [sections, report_path, write_confirmed]
        properties:
          report_path:
            type: string
            enum: [./report.md]
          write_confirmed:
            type: boolean
            enum: [true]
          sections:
            type: array
            minItems: 1
            items:
              type: object
              additionalProperties: false
              required: [id, title, guidance, marker]
              properties:
                id:
                  type: string
                title:
                  type: string
                guidance:
                  type: string
                marker:
                  type: string

  - id: iterative_research
    kind: fleet
    role: IterativeResearcher
    fleet:
      worker_count: 3
      fanout_from: planner.sections
      task_mapping:
        section_id: item.id
        section_title: item.title
        section_guidance: item.guidance
        section_marker: item.marker
      agent:
        name: IterativeResearcher
        provider: anthropic
        model: claude-haiku-4-5
        options:
          max_tokens: 1400
          max_retries: 6
        instructions: |
          You are assigned one section of ./report.md.
          Do targeted research with perplexity_search and webfetch.
          You may call perplexity_search at most 3 times for this section.
          Use at most 1 webfetch call for this section unless strictly needed.
          Summarize findings; do not include large quoted source text.
          Edit only your section marker block.
          Your marker namespace is provided as section_marker (example: SECTION:section_1).
          Use exactly one edit call with:
          - old_string = full current block between <!-- {section_marker}:START --> and <!-- {section_marker}:END -->
          - new_string = same markers and heading, but replace TODO body with final content
          Do not edit outside your marker block.
          Return structured JSON when finished.
        tools: [perplexity_search, webfetch, read, edit]
        output_schema:
          type: object
          additionalProperties: false
          required: [section_id, status]
          properties:
            section_id:
              type: string
            status:
              type: string
              enum: [done]

  - id: proofreader
    kind: agent
    role: Proofreader
    agent:
      name: Proofreader
      provider: anthropic
      model: claude-haiku-4-5
      options:
        max_tokens: 700
        max_retries: 6
      instructions: |
        Do a final lightweight proofreading pass over ./report.md.
        Read the report once, then perform at most one edit call for minor polish.
        Do not do additional research or extra edit loops.
        Improve spelling and readability without changing intent.
        Return structured JSON status.
      tools: [read, edit]
      output_schema:
        type: object
        additionalProperties: false
        required: [status]
        properties:
          status:
            type: string
            enum: [done]

edges:
  - from: planner
    to: iterative_research
    map:
      sections: output.sections

  - from: iterative_research
    to: proofreader
    when: all_workers_done
    map:
      completed_sections: output.completed
